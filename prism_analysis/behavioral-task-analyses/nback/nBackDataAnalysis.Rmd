---
title: 'nbackDataAnalysis'
output: html_document
---

```{r Setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Loading necessary files and packages for analysis
```{r Loading files and packages}
library(lme4)
library(dplyr)
library(emmeans)
library(ggplot2)
library(car)
library(lmerTest)
library(interactions)
library(MASS)
library(sjPlot)
library(brms)
library(glmmTMB)
emm_options(pbkrtest.limit = 8856)
emm_options(lmerTest.limit = 8856)

nBack_exp = read.csv(file = 'n-back_exp_results.csv')

cbPalette <- c('#E69F00', '#56B4E9', '#009E73', '#F0E442', '#0072B2', '#D55E00', '#CC79A7')

stim_siteLabs <- c('Vertex', 'DAN', 'FPCN-B')
names(stim_siteLabs) <- c('vertex', 'DAN', 'FPCNB')
nBack_Labs <- c('0', '1', '2')
timepoint_Labs <- c('Pre', 'Post')
names(timepoint_Labs) <- c('pre', 'post')
```


Data cleaning for accuracy analysis
```{r General data cleaning, echo=FALSE}
#changing relevant variables to factors
nBack_exp$n_back <- as.factor(nBack_exp$n_back)
nBack_exp$trialN <- as.factor(nBack_exp$trialN)
nBack_exp$counterbalance <- as.factor(nBack_exp$counterbalance)
nBack_exp$sessionNum <- as.factor(nBack_exp$sessionNum)
nBack_exp$timepoint <- as.factor(nBack_exp$timepoint)
nBack_exp$stim_site <- as.factor(nBack_exp$stim_site)
```

# Accuracy Data Analysis

## Covariate Analysis

### Counterbalance
```{r Covariate analysis for counterbalance}
# filter csv to only include rows where trial was before stim and a n-back trial
nBack_exp_Covariates <- nBack_exp %>% filter(timepoint == 'pre', trialType == 1)

# group above filtered data by subj, n-back type, and counterbalance; also add columns to summarize accuracy across these groupings
nBack_SummaryCB <- nBack_exp_Covariates %>% group_by(subject, n_back, counterbalance) %>% summarize(meanAcc = mean(correct), stdAcc = sd(correct))

# plot the summary stats generated above
# initial ggplot call solely loads data, specifying which var is the x and y
# further lines specify what plots in particular of interest, along with params on their appearance such as width
# facet_grid: takes collapsed data and spreads it out to graph by a particular var that is specified
ggplot(nBack_SummaryCB, aes(counterbalance, meanAcc, fill = counterbalance)) +
  geom_violin() +
  geom_boxplot(width = .2, alpha = .2) +
  theme_classic() +
  xlab(label = 'Counterbalance Number') +
  ylab(label = 'Mean Accuracy (Percentage)') +
  # title for figure: Pre-TMS Mean Accuracy for Each Counterbalance\n by N-Back Load
  labs(subtitle = 'N-Back Load', fill = 'Counterbalance') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin=margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ n_back) +
  scale_fill_manual(values = cbPalette)


# filter current data across counterbalances, n-back type, and subject for only certain trials (ex: 0, 1, 2)
# run ANOVA on filtered data for certain n-back loads with aov() function
# call summary on ANOVA to see result
nBack_anovaCB_n0 <- nBack_SummaryCB %>% filter(n_back == 0)
counterbalanceAnovan0 <- aov(meanAcc ~ counterbalance, data = nBack_anovaCB_n0)
summary(counterbalanceAnovan0)

nBack_anovaCB_n1 <- nBack_SummaryCB %>% filter(n_back == 1)
counterbalanceAnovan1 <- aov(meanAcc ~ counterbalance, data = nBack_anovaCB_n1)
summary(counterbalanceAnovan1)

nBack_anovaCB_n2 <- nBack_SummaryCB %>% filter(n_back == 2)
counterbalanceAnovan2 <- aov(meanAcc ~ counterbalance, data = nBack_anovaCB_n2)
summary(counterbalanceAnovan2)
```

### Session number
```{r Covariate analysis for session number}
# use initial filtered csv to group by subj, n-back type, and session number; also add columns as above to summarize accuracy across these groupings
nBack_SummarySess <- nBack_exp_Covariates %>% group_by(subject, n_back, sessionNum) %>% summarize(meanAcc = mean(correct), stdAcc = sd(correct))

# plot the summary stats generated in previous lines
ggplot(nBack_SummarySess, aes(sessionNum, meanAcc, fill = sessionNum)) +
  geom_violin(width = 1) +
  geom_boxplot(width = .2, alpha = .2) +
  theme_classic() +
  xlab(label = 'Session Number') +
  ylab(label = 'Mean Accuracy (Percentage)') +
  # title for figure: Pre-TMS Mean Accuracy for Each Session Number\n by N-Back Load
  labs(subtitle = 'N-Back Load', fill= 'Session Number') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t=10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ n_back) +
  scale_fill_manual(values = cbPalette)


# filter current data across session number, n-back type, and subject for only certain trials again to run ANOVA and see results
nBack_anovaSess_n0 <- nBack_SummarySess %>% filter(n_back == 0)
sessAnovan0 <- aov(meanAcc ~ sessionNum, data = nBack_anovaSess_n0)
summary(sessAnovan0)

nBack_anovaSess_n1 <- nBack_SummarySess %>% filter(n_back == 1)
sessAnovan1 <- aov(meanAcc ~ sessionNum, data = nBack_anovaSess_n1)
summary(sessAnovan1)

nBack_anovaSess_n2 <- nBack_SummarySess %>% filter(n_back == 2)
sessAnovan2 <- aov(meanAcc ~ sessionNum, data = nBack_anovaSess_n2)
summary(sessAnovan2)
```

### Days in between sessions
```{r Covariate analysis for days in between sessions on mean accuracy}
# use init filt csv to group by subj, n-back type, and days in between sessions ; also add sum stats column
nBack_SummaryDays <- nBack_exp_Covariates %>% group_by(subject, n_back, days) %>% summarize(meanAcc = mean(correct), stdAcc = sd(correct))

# plot the summary stats gen'd
ggplot(nBack_SummaryDays, aes(days, meanAcc)) +
  geom_point() + 
  geom_smooth(method = lm, se=FALSE) + 
  theme_classic() +
  xlab(label = 'Number of Days in Between Sessions') +
  ylab(label = 'Mean Accuracy (Percentage)') +
  # title for figure: Pre-TMS Mean Accuracy for Days in between Sessions\n by N-Back Load
  labs(subtitle = 'N-Back Load') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t=10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ n_back) +
  scale_colour_manual(values = cbPalette)


# filter across days, n-back,type and subject
nBack_anovaDays_n0 <- nBack_SummaryDays %>% filter(n_back == 0)
daysAnovan0 <- aov(meanAcc ~ days, data = nBack_anovaDays_n0)
summary(daysAnovan0)

nBack_anovaDays_n1 <- nBack_SummaryDays %>% filter(n_back == 1)
daysAnovan1 <- aov(meanAcc ~ days, data = nBack_anovaDays_n1)
summary(daysAnovan1)

nBack_anovaDays_n2 <- nBack_SummaryDays %>% filter(n_back == 2)
daysAnovan2 <- aov(meanAcc ~ days, data = nBack_anovaDays_n2)
summary(daysAnovan2)
```

## Data cleaning for linear mixed effects models
```{r Data cleaning for accuracy models}
#changing reference level of timepoint to pre to make interpretation of models easier
nBack_exp$timepoint <- relevel(nBack_exp$timepoint, ref = 'pre')
nBack_exp$stim_site <-relevel(nBack_exp$stim_site, ref = 'vertex')
nBack_exp$n_back <- relevel(nBack_exp$n_back, ref = '0')
#nBack_exp$daysC <- scale(nBack_exp$days, scale = FALSE)
#keeping only ``n-back`` trials for analysis
nBack_exp_filter <- nBack_exp %>% filter(trialType == 1)
```

## Linear models
### Two-way analysis of Pre/Post TMS and n-back load (0,1,2) interaction
```{r Two-way interaction between pre/post TMS and cog load for accuracy}
#getting data frame for graphs, grouping by subject, n_back load, and pre/post-TMS and then calculating mean and standard deviation for accuracy
nBack_summaryTimeCog <- nBack_exp_filter %>% group_by(subject, n_back, timepoint) %>% summarize(meanAcc = mean(correct), stdAcc = sd(correct))

#plot of above data frame
ggplot(nBack_summaryTimeCog, aes(timepoint, meanAcc, fill = timepoint)) +
  geom_violin(width = 1) +
  geom_boxplot(width = .2, alpha = .2) +
  theme_classic() +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Mean Accuracy (Percentage)') +
  # title for figure: Mean Accuracy for Pre/Post-TMS\n by N-Back Load
  labs(subtitle = 'N-Back Load', fill = 'Stimulation Time Point') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ n_back) +
  scale_fill_manual(values = cbPalette, labels = timepoint_Labs) +
  scale_x_discrete(labels = timepoint_Labs)


#model with interaction term (n_back load and pre/post TMS)
TimeCog_m1 <- glmer(correct ~ n_back * timepoint + days + (1 + days | subject:timepoint), family = binomial, data = nBack_exp_filter)
#model without interaction term, used to compare in likelihood ratio test
TimeCog_m2 <- glmer(correct ~ n_back + timepoint + days + (1 + days | subject:timepoint), family = binomial, data = nBack_exp_filter)
#likelihood ratio test comparing model with interaction term and one with out
anova(TimeCog_m1, TimeCog_m2)
#summary of model with interaction term to examine beta coefficients and random effect term
summary(TimeCog_m1)
#vif of model
vif(TimeCog_m1)
#tablated model
tab_model(TimeCog_m1)


#paired contrasts of each n_back load by pre and post TMS (only pre is relevant here, really a sanity check to see if baseline levels differ as a function of n_back load)
emmTimeCog_timepoint <- emmeans(TimeCog_m1, ~ n_back | timepoint, param = 'logk')
pairs(emmTimeCog_timepoint)
# graph of paired contrasts for model fitted data
emmAcc1 <- as.data.frame(emmTimeCog_timepoint)
ggplot(emmAcc1, aes(x = timepoint, y = emmean, group = n_back, color = n_back)) +
  geom_point() + 
  geom_line() + 
  geom_errorbar(width = .1, aes(ymin = asymp.LCL, ymax = asymp.UCL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Estimated Marginal Means') +
  # title for figure: Estimated Marginal Means of Each N-Back Load by Stimulation Time Point 
  labs(subtitle = 'N-Back Load', color = 'N-Back Load') +
  scale_x_discrete(labels = timepoint_Labs) +
  scale_colour_manual(values = cbPalette) +
  facet_grid(. ~ n_back)


#paired contrasts of pre - post TMS for each n_back load
emmTimeCog_nBack <- emmeans(TimeCog_m1, ~ timepoint | n_back, param = 'logk')
pairs(emmTimeCog_nBack)
#graph of paired contrasts for model fitted data
emmAcc2 <- as.data.frame(emmTimeCog_nBack)
ggplot(emmAcc2, aes(x = n_back, y = emmean, group = timepoint, color = timepoint)) +
  geom_point() + 
  geom_line() + 
  geom_errorbar(width = .1, aes(ymin = asymp.LCL, ymax = asymp.UCL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin=margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'N-Back Load') +
  ylab(label = 'Estimated Marginal Means') +
  # title for figure: Estimated Marginal Means of Stimulation Time Point by N-Back Load
  labs(subtitle = 'Stimulation Time Point', color = 'Stimulation Time Point') +
  scale_x_discrete(labels = nBack_Labs) +
  scale_colour_manual(values = cbPalette, labels = timepoint_Labs) +
  facet_grid(. ~ timepoint, labeller = labeller(timepoint = timepoint_Labs))


#contrasts of contrasts for pre - post TMS across n_back loads
TimeCogContrasts <- emmeans(TimeCog_m1, pairwise ~ timepoint * n_back, param = 'logk')
contrast(TimeCogContrasts[[1]], interaction = c(n_back = 'pairwise'))
```
### Two-way analysis of Pre/Post TMS and Stimulation Site
```{r Two-way interaction for pre/post TMS and stim site on accuracy}
#getting data frame for graphs, grouping by subject, stimulation site, and pre/post-TMS and then calculating mean and standard deviation for accuracy
nBack_summaryTimeSite <- nBack_exp_filter %>% group_by(subject, stim_site, timepoint) %>% summarize(meanAcc = mean(correct), stdAcc = sd(correct))

#plot of above data frame
ggplot(nBack_summaryTimeSite, aes(timepoint, meanAcc, fill = timepoint)) +
  geom_violin(width = 1) +
  geom_boxplot(width = .2, alpha = .2) +
  theme_classic() +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Mean Accuracy (Percentage)') +
  # name of figure: Mean Accuracy for Pre/Post-TMS\n by Stimulation Site
  labs(subtitle = 'Stimulation Site', fill = 'Stimulation Time Point') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ stim_site, labeller = labeller(stim_site = stim_siteLabs)) +
  scale_fill_manual(values = cbPalette, labels = timepoint_Labs) +
  scale_x_discrete(labels = timepoint_Labs)


#model with interaction term (stim site and pre/post TMS)
TimeSite_m1 <- glmer(correct ~ stim_site * timepoint + days + (1 + days | subject:timepoint), family = binomial, data = nBack_exp_filter)
#model without interaction term, used to compare in likelihood ratio test
TimeSite_m2 <- glmer(correct ~ stim_site + timepoint + days + (1 + days | subject:timepoint), family = binomial, data = nBack_exp_filter)
#likelihood ratio test comparing model with interaction term and one with out
anova(TimeSite_m1, TimeSite_m2)
#summary of model with interaction term to examine beta coefficients and random effect term
summary(TimeSite_m1)
#vif of model
vif(TimeSite_m1)
#tablated model
tab_model(TimeSite_m1)


#paired contrasts of each stimulation site by pre and post TMS (only pre is relevant here, really a sanity check to see if baseline levels differ as a function of stimulation site)
emmTimeSite_timepoint <- emmeans(TimeSite_m1, ~ stim_site | timepoint, param = 'logk')
pairs(emmTimeSite_timepoint) 
#graph of paired contrasts for model fitted data
emmAcc3 <- as.data.frame(emmTimeSite_timepoint)
ggplot(emmAcc3, aes(x = timepoint, y = emmean, group = stim_site, color = stim_site)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = asymp.LCL, ymax = asymp.UCL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Estimated Marginal Means') +
  # name of figure: Estimated Marginal Means of Each Stimulation Site by Stimulation Time Point
  labs(subtitle = 'Stimulation Site', color = 'Stimulation Site') +
  scale_x_discrete(label=timepoint_Labs) +
  scale_colour_manual(values=cbPalette, labels = stim_siteLabs) +
  facet_grid(. ~ stim_site, labeller = labeller(stim_site = stim_siteLabs))


#paired contrasts of pre - post TMS for each stimulation site
emmTimeSite_stimSite <- emmeans(TimeSite_m1, ~ timepoint | stim_site, param = 'logk')
pairs(emmTimeSite_stimSite)
#graph of paired contrasts for model fitted data
emmAcc4 <- as.data.frame(emmTimeSite_stimSite)
ggplot(emmAcc4, aes(x = stim_site, y = emmean, group = timepoint, color = timepoint)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = asymp.LCL, ymax = asymp.UCL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Time Point by Stimulation Site
  labs(subtitle = 'Stimulation Time Point', color = 'Stimulation Time Point') +
  scale_x_discrete(labels = stim_siteLabs) +
  scale_colour_manual(values = cbPalette, labels = timepoint_Labs) +
  facet_grid(. ~ timepoint, labeller = labeller(timepoint = timepoint_Labs))


#contrasts of contrasts for pre - post TMS across stimulation sites
TimeSiteContrasts <- emmeans(TimeSite_m1, pairwise ~ timepoint * stim_site, param = 'logk')
contrast(TimeSiteContrasts[[1]], interaction = c(stim_site = 'pairwise'))
```

### Three-way analysis of Pre/Post TMS, Stimulation Site (DAN, Vertex, FPCN-B) and n back load (0,1,2) interaction
```{r Three-way interaction accuracy}
#getting data frame for graphs. Grouping by subject, n_back load, pre/post TMS, and stimulation site. Then calculating mean and standard deviation accuracy
nBack_summaryTimeCogSess <- nBack_exp_filter %>% group_by(subject, n_back, timepoint, stim_site) %>% summarize(meanAcc = mean(correct), stdAcc = sd(correct))

#plot of above data frame
ggplot(nBack_summaryTimeCogSess, aes(timepoint, meanAcc, fill = timepoint)) +
  geom_violin(width = 1) +
  geom_boxplot(width = .1, alpha = .2) +
  theme_classic() +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Mean Accuracy (Percentage)') +
  # title of figure: Mean Accuracy for Pre/Post-TMS\n by N-Back Load and Stimulation Site
  labs(subtitle = 'N-Back Load', fill = 'Stimulation Time Point') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(stim_site ~ n_back, labeller = labeller(stim_site = stim_siteLabs)) +
  scale_fill_manual(values = cbPalette, labels = timepoint_Labs) +
  scale_x_discrete(labels = timepoint_Labs) +
  scale_y_continuous(sec.axis = sec_axis(~ ., name = 'Stimulation Site', breaks = NULL, labels = NULL))


#model with three-way interaction term. NOTE: ran into convergence issues when model was first run, elected to change optimizer to see if model converged. Below is the approach used
TimeCogSess_m1 <- glmer(correct ~ n_back * timepoint * stim_site + days + (1 + days|subject:timepoint), family = binomial, data = nBack_exp_filter, control=glmerControl(optimizer='bobyqa',optCtrl=list(maxfun=100000)))
#model without three-way interaction term
TimeCogSess_m2 <- glmer(correct ~ n_back + timepoint + stim_site + days +  n_back:timepoint + n_back:stim_site + timepoint:stim_site + (1 + days|subject:timepoint),  family = binomial, data = nBack_exp_filter, control=glmerControl(optimizer='bobyqa',optCtrl=list(maxfun=100000)))
#anova comparing two models above
anova(TimeCogSess_m1, TimeCogSess_m2)
#summary of three-way interaction term model
summary(TimeCogSess_m1)
#vif of three-way interaction term model
vif(TimeCogSess_m1)
#tablated model
tab_model(TimeCogSess_m1)


#paired contrasts for differences between stimulation site for each n_back load and pre/post TMS (only pre is relevant here, really a sanity check to see if baseline levels differ as a function of n_back load but not across stimulation site)
emmTimeCogSess_TimeCog <- emmeans(TimeCogSess_m1, ~ stim_site| timepoint * n_back, param = 'logk')
pairs(emmTimeCogSess_TimeCog)
#graph of paired contrasts for model fitted data
acc3Way_TimeCog <- as.data.frame(emmTimeCogSess_TimeCog)
ggplot(acc3Way_TimeCog, aes(x = stim_site, y = emmean, group = timepoint, color = n_back)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = asymp.LCL, ymax = asymp.UCL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Site') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Site by \nStimulation Time Point and N-Back Load
  labs(subtitle = 'Stimulation Time Point', color = 'N-Back Load') +
  scale_x_discrete(labels = stim_siteLabs) +
  scale_colour_manual(values=cbPalette, labels = nBack_Labs) +
  facet_grid(n_back ~ timepoint, labeller = labeller(timepoint = timepoint_Labs)) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'N-Back Load', breaks = NULL, labels = NULL))

ggplot(acc3Way_TimeCog, aes(x = stim_site, y = emmean, color = stim_site)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = asymp.LCL, ymax = asymp.UCL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Site') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Site by \nStimulation Time Point and N-Back Load 
  labs(subtitle = 'Stimulation Time Point', color = 'Stimulation Site') +
  scale_x_discrete(labels = stim_siteLabs) +
  scale_colour_manual(values = cbPalette, labels = stim_siteLabs) +
  facet_grid(n_back ~ timepoint, labeller = labeller(timepoint = timepoint_Labs)) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'n-Back Load', breaks = NULL, labels = NULL))

ggplot(acc3Way_TimeCog, aes(x = stim_site, y = emmean, group = n_back, color = stim_site)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = asymp.LCL, ymax = asymp.UCL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Site') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Site by \nStimulation Time Point and N-Back Load
  labs(subtitle = 'Stimulation Time Point', color = 'Stimulation Site') +
  scale_x_discrete(labels = stim_siteLabs) +
  scale_colour_manual(values = cbPalette, labels = stim_siteLabs) +
  facet_grid(n_back ~ timepoint, labeller = labeller(timepoint = timepoint_Labs)) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'n-Back Load', breaks = NULL, labels = NULL))


#paired contrasts for pre - post TMS for each n_back load and stimulation site
emmTimeCogSess_SiteCog <- emmeans(TimeCogSess_m1, ~ timepoint | stim_site * n_back, param = 'logk') 
pairs(emmTimeCogSess_SiteCog)
#graph of paired contrasts for model fitted data
acc3Way_SiteCog <- as.data.frame(emmTimeCogSess_SiteCog)
ggplot(acc3Way_SiteCog, aes(x = timepoint, y = emmean, group = stim_site, color = n_back)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = asymp.LCL, ymax = asymp.UCL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Time Point by \nStimulation Site and N-Back Load
  labs(subtitle = 'Stimulation Site', color = 'N-Back Load') +
  scale_x_discrete(label = timepoint_Labs) +
  scale_colour_manual(values = cbPalette) +
  facet_grid(n_back ~ stim_site, labeller = labeller(stim_site = stim_siteLabs)) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'N-Back Load', breaks = NULL, labels = NULL))


#contrasts of contrasts for pre - post TMS across n_back load for each stimulation site
TimeCogSessContrastsTwoWayStim <- emmeans(TimeCogSess_m1, pairwise ~ timepoint * n_back | stim_site, param = 'logk')
contrast(TimeCogSessContrastsTwoWayStim[[1]], interaction = c(n_back = 'pairwise'))

#contrasts of contrasts for pre - post TMS across stimulation sites trial types for each n_back load
TimeCogSessContrastsTwoWayNback <- emmeans(TimeCogSess_m1, pairwise ~ timepoint* stim_site | n_back, param = 'logk')
contrast(TimeCogSessContrastsTwoWayNback[[1]], interaction = c(n_back = 'pairwise'))

#contrasts of contrasts of contrasts for pre-post TMS for n_back load for stimulation site
TimeCogSessContrastsThreeWay <- emmeans(TimeCogSess_m1, pairwise ~ timepoint* stim_site * n_back, param = 'logk')
contrast(TimeCogSessContrastsThreeWay[[1]], interaction = c(n_back = 'pairwise'))
```

# Reaction Time Data Analysis

Loading data for analysis and cleaning
```{r Loading and cleaning data for RT, echo=FALSE}

nBack_exp_RT = read.csv(file = 'n-back_exp_results_RTfiltered.csv')
#changing relevant variables to factors
nBack_exp_RT$n_back <- as.factor(nBack_exp_RT$n_back)
nBack_exp_RT$trialN <- as.factor(nBack_exp_RT$trialN)
nBack_exp_RT$counterbalance <- as.factor(nBack_exp_RT$counterbalance)
nBack_exp_RT$sessionNum <- as.factor(nBack_exp_RT$sessionNum)
nBack_exp_RT$timepoint <- as.factor(nBack_exp_RT$timepoint)
nBack_exp_RT$stim_site <- as.factor(nBack_exp_RT$stim_site)
# filter csv to only include rows where trial was before stim and a n-back trial
nBack_exp_RT_Covariates <- nBack_exp_RT %>% filter(timepoint == 'pre', trialType == 1)
```


## Covariate Analysis

### Counterbalance

```{r Covariate analysis for counterbalance in reaction time}

# group above filtered data by subj, n-back type, and counterbalance; also add columns to summarize reaction time across these groupings
nBack_RT_SummaryCB <- nBack_exp_RT_Covariates %>% group_by(subject, n_back, counterbalance) %>% summarize(medianRT = median(rt), stdRT = sd(rt))

# plot the summary stats generated above
# initial ggplot call solely loads data, specifying which var is the x and y
# further lines specify what plots in particular of interest, along with params on their appearance such as width
# facet_grid: takes collapsed data and spreads it out to graph by a particular var that is specified
ggplot(nBack_RT_SummaryCB, aes(counterbalance, medianRT, fill = counterbalance)) +
  geom_violin() +
  geom_boxplot(width = .2, alpha = .2) +
  theme_classic() +
  xlab(label = 'Counterbalance Number') +
  ylab(label = 'Median Reaction Time (in seconds)') +
  # title of figure: Pre-TMS Median Reaction Time for Each Counterbalance\n by N-Back Load
  labs(subtitle = 'N-Back Load', fill = 'Counterbalance') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ n_back) +
  scale_fill_manual(values = cbPalette)


# filter current data across counterbalances, n-back type, and subject for only certain trials (ex: 0, 1, 2)
# run ANOVA on filtered data for certain n-back loads with aov() function
# call summary on ANOVA to see result
nBack_RT_anovaCB_n0 <- nBack_RT_SummaryCB %>% filter(n_back == 0)
counterbalanceAnovan0RT <- aov(medianRT ~ counterbalance, data = nBack_RT_anovaCB_n0)
summary(counterbalanceAnovan0RT)

nBack_RT_anovaCB_n1 <- nBack_RT_SummaryCB %>% filter(n_back == 1)
counterbalanceAnovan1RT <- aov(medianRT ~ counterbalance, data = nBack_RT_anovaCB_n1)
summary(counterbalanceAnovan1RT)

nBack_RT_anovaCB_n2 <- nBack_RT_SummaryCB %>% filter(n_back == 2)
counterbalanceAnovan2RT <- aov(medianRT ~ counterbalance, data = nBack_RT_anovaCB_n2)
summary(counterbalanceAnovan2RT)
```

### Session number
```{r Covariate analysis for session number in reaction time}
# use initial filtered csv to group by subj, n-back type, and session; also add columns as above to summarize accuracy across these groupings
nBack_RT_SummarySess <- nBack_exp_RT_Covariates %>% group_by(subject, n_back, sessionNum) %>% summarize(medianRT = median(rt), stdRT = sd(rt))

# plot the summary stats generated in previous lines
ggplot(nBack_RT_SummarySess, aes(sessionNum, medianRT, fill = sessionNum)) +
  geom_violin(width = 1) +
  geom_boxplot(width = .2, alpha = .2) +
  theme_classic() +
  xlab(label = 'Session Number') +
  ylab(label = 'Median Reaction Time (in seconds)') +
  # title of figure: Pre-TMS Median Reaction Time for Each Session Number\n by N-Back Load
  labs(subtitle = 'N-Back Load', fill = 'Session Number') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ n_back) +
  scale_fill_manual(values = cbPalette)


# filter current data across session number, n-back type, and subject for only certain trials again to run ANOVA and see results
nBack_RT_anovaSess_n0 <- nBack_RT_SummarySess %>% filter(n_back == 0)
sessAnovan0RT <- aov(medianRT ~ sessionNum, data = nBack_RT_anovaSess_n0)
summary(sessAnovan0RT)

nBack_RT_anovaSess_n1 <- nBack_RT_SummarySess %>% filter(n_back == 1)
sessAnovan1RT <- aov(medianRT ~ sessionNum, data = nBack_RT_anovaSess_n1)
summary(sessAnovan1RT)

nBack_RT_anovaSess_n2 <- nBack_RT_SummarySess %>% filter(n_back == 2)
sessAnovan2RT <- aov(medianRT ~ sessionNum, data = nBack_RT_anovaSess_n2)
summary(sessAnovan2RT)
```

### Days in between sessions
```{r Covariate analysis for days in between sessions on reaction time}
# use init filt csv to group by subj, n-back type, and days in between sessions ; also add sum stats column
nBack_SummaryDays <- nBack_exp_RT_Covariates %>% group_by(subject, n_back, days) %>% summarize(medianRT = median(rt), stdRT = sd(rt))

# plot the summary stats gen'd
ggplot(nBack_SummaryDays, aes(days, medianRT)) +
  geom_point() + 
  geom_smooth(method = lm, se=FALSE) +
  theme_classic() +
  xlab(label = 'Days in Between Sessions') +
  ylab(label = 'Median Reaction Time (in seconds)') +
  # title of figure: Pre-TMS Median Reaction Time for Days in between Sessions\n by N-Back Load
  labs(subtitle = 'N-Back Load') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ n_back) +
  scale_colour_manual(values = cbPalette)


# filter across days, n-back,type and subject
nBack_RT_anovaDays_n0 <- nBack_SummaryDays %>% filter(n_back == 0)
daysAnovan0RT <- aov(medianRT ~ days, data = nBack_RT_anovaDays_n0)
summary(daysAnovan0RT)

nBack_RT_anovaDays_n1 <- nBack_SummaryDays %>% filter(n_back == 1)
daysAnovan1RT <- aov(medianRT ~ days, data = nBack_RT_anovaDays_n1)
summary(daysAnovan1RT)

nBack_RT_anovaDays_n2 <- nBack_SummaryDays %>% filter(n_back == 2)
daysAnovan2RT <- aov(medianRT ~ days, data = nBack_RT_anovaDays_n2)
summary(daysAnovan2RT)
```

## Data cleaning for linear mixed effects models
```{r Data cleaning for reaction time models}
#changing reference level of timepoint to pre to make interpretation of models easier
nBack_exp_RT$timepoint <- relevel(nBack_exp_RT$timepoint, ref = 'pre')
nBack_exp_RT$stim_site <-relevel(nBack_exp_RT$stim_site, ref = 'vertex')
#keeping only ``n-back`` trials for analysis
nBack_exp_filter_RT <- nBack_exp_RT %>% filter(trialType == 1)
#nBack_exp_filter_RT$daysC <- scale(nBack_exp_filter_RT$days, scale = FALSE)
# apply log transform on data to feed to models
nBack_exp_filter_RT$logrt <- log(nBack_exp_filter_RT$rt)
```

## Linear models
### Two-way analysis of Pre/Post TMS and n-back load (0,1,2) interaction
```{r Two-way interaction for reaction time}
#getting data frame for graphs, grouping by subject, n_back load, and pre/post-TMS and then calculating mean and standard deviation for accuracy
nBack_summaryTimeCog <- nBack_exp_filter_RT %>% group_by(subject, n_back, timepoint) %>% summarize(medianRT = median(logrt), stdRT = sd(logrt))

#plot of above data frame
ggplot(nBack_summaryTimeCog, aes(timepoint, medianRT, fill = timepoint)) +
  geom_violin(width = 1) +
  geom_boxplot(width = .2, alpha = .2) +
  theme_classic() +
  xlab(label = 'Session Number') +
  ylab(label = 'Log Transformed Reaction Time') +
  # title of figure: Log Transformed RT for Pre/Post-TMS\n by N-Back Load
  labs(subtitle = 'N-Back Load', fill = 'Stimulation Time Point') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ n_back) +
  scale_fill_manual(values = cbPalette, labels = timepoint_Labs) +
  scale_x_discrete(labels = timepoint_Labs)


#model with interaction term (n_back load and pre/post TMS)
TimeCog_m1 <- lmer(logrt ~ n_back * timepoint + days + (1 + days | subject:timepoint), data = nBack_exp_filter_RT, control=lmerControl(optimizer='bobyqa',optCtrl=list(maxfun=100000)))
#model without interaction term, used to compare in likelihood ratio test
TimeCog_m2 <- lmer(logrt ~ n_back + timepoint + days + (1 + days | subject:timepoint), data = nBack_exp_filter_RT,  control=lmerControl(optimizer='bobyqa',optCtrl=list(maxfun=100000)))
#likelihood ratio test comparing model with interaction term and one with out
anova(TimeCog_m1, TimeCog_m2)
#summary of model with interaction term to examine beta coefficients and random effect term
summary(TimeCog_m1)
#vif of model
vif(TimeCog_m1)
#tablated model
tab_model(TimeCog_m1)


#paired contrasts of each n_back load by pre and post TMS (only pre is relevant here, really a sanity check to see if baseline levels differ as a function of n_back load)
emmTimeCog_timepoint_RT <- emmeans(TimeCog_m1, ~ n_back | timepoint, param = 'logk')
pairs(emmTimeCog_timepoint_RT)
#graph of paired contrasts for model fitted data
emmRT1 <- as.data.frame(emmTimeCog_timepoint_RT)
ggplot(emmRT1, aes(x = timepoint, y = emmean, group = n_back, color = n_back)) +
  geom_point() + 
  geom_line() + 
  geom_errorbar(width = .1, aes(ymin = lower.CL , ymax = upper.CL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Each N-Back Load by Stimulation Time Point
  labs(subtitle = 'N-Back Load', color = 'N-Back Load') +
  scale_x_discrete(labels = timepoint_Labs) +
  scale_colour_manual(values = cbPalette) +
  facet_grid(. ~ n_back)


#paired contrasts of pre - post TMS for each n_back load
emmTimeCog_nBack_RT <- emmeans(TimeCog_m1, ~ timepoint | n_back, param = 'logk')
pairs(emmTimeCog_nBack_RT)
#graph of paired contrasts for model fitted data
emmRT2 <- as.data.frame(emmTimeCog_nBack_RT)
ggplot(emmRT2, aes(x = n_back, y = emmean, group = timepoint, color = timepoint)) +
  geom_point() + 
  geom_line() + 
  geom_errorbar(width = .1, aes(ymin = lower.CL, ymax = upper.CL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'N-Back Load') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Time Point by N-Back Load
  labs(subtitle = 'Stimulation Time Point', color = 'Stimulation Time Point') +
  scale_x_discrete(labels = nBack_Labs) +
  scale_colour_manual(values = cbPalette, labels = timepoint_Labs) +
  facet_grid(. ~ timepoint, labeller = labeller(timepoint = timepoint_Labs))


#contrasts of contrasts for pre - post TMS across n_back loads
TimeCogContrasts <- emmeans(TimeCog_m1, pairwise ~ timepoint * n_back, param = 'logk')
contrast(TimeCogContrasts[[1]], interaction = c(n_back = 'pairwise'))
```

### Two-way analysis of Pre/Post TMS and stimulation site interaction
```{r Two-way interaction for pre/post TMS and stimulation site on reaction time}
#getting data frame for graphs, grouping by subject, stimulation site, and pre/post-TMS and then calculating mean and standard deviation for accuracy
nBack_summaryTimeSite <- nBack_exp_filter_RT %>% group_by(subject, stim_site, timepoint) %>% summarize(medianRT = median(logrt), stdRT = sd(logrt))

#plot of above data frame
ggplot(nBack_summaryTimeSite, aes(timepoint, medianRT, fill = timepoint)) +
  geom_violin(width = 1) +
  geom_boxplot(width = .2, alpha = .2) +
  theme_classic() +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Log Transformed Reaction Time') +
  # title of figure: Log Transformed Reaction Time for Pre/Post-TMS\n by Stimulation Site
  labs(subtitle = 'Stimulation Site', fill = 'Stimulation Time Point') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(. ~ stim_site, labeller = labeller(stim_site = stim_siteLabs)) +
  scale_fill_manual(values = cbPalette, labels = timepoint_Labs) +
  scale_x_discrete(labels = timepoint_Labs)

#model with interaction term (stimulation site and pre/post TMS)
TimeSite_m1 <- lmer(logrt ~ stim_site * timepoint + days + (1 + days | subject:timepoint), data = nBack_exp_filter_RT, control=lmerControl(optimizer='bobyqa',optCtrl=list(maxfun=100000)))
#model without interaction term, used to compare in likelihood ratio test
TimeSite_m2 <- lmer(logrt ~ stim_site + timepoint + days + (1 + days | subject:timepoint), data = nBack_exp_filter_RT, control=lmerControl(optimizer='bobyqa',optCtrl=list(maxfun=100000)))
#likelihood ratio test comparing model with interaction term and one with out
anova(TimeSite_m1, TimeSite_m2)
#summary of model with interaction term to examine beta coefficients and random effect term
summary(TimeSite_m1)
#vif of model
vif(TimeSite_m1)
#tablated model
tab_model(TimeSite_m1)


#paired contrasts of each stimulation site by pre and post TMS (only pre is relevant here, really a sanity check to see if baseline levels differ as a function of stimulation site)
emmTimeSite_timepoint_RT <- emmeans(TimeSite_m1, ~ stim_site | timepoint, param = 'logk')
pairs(emmTimeSite_timepoint_RT)
#graph of paired contrasts for model fitted data
emmRT3 <- as.data.frame(emmTimeSite_timepoint_RT)
ggplot(emmRT3, aes(x = timepoint, y = emmean, group = stim_site, color = stim_site)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = lower.CL, ymax = upper.CL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Estimated Marginal Means') +
  # name of figure: Estimated Marginal Means of Each Stimulation Site by Stimulation Time Point
  labs(subtitle = 'Stimulation Site', color = 'Stimulation Site') +
  scale_x_discrete(label = timepoint_Labs) +
  scale_colour_manual(values = cbPalette, labels = stim_siteLabs) +
  facet_grid(. ~ stim_site, labeller = labeller(stim_site = stim_siteLabs))

#paired contrasts of pre - post TMS for each stimulation site
emmTimeSite_stimSite_RT <- emmeans(TimeSite_m1, ~ timepoint | stim_site, param = 'logk')
pairs(emmTimeSite_stimSite_RT)
#graph of paired contrasts for model fitted data
emmRT4 <- as.data.frame(emmTimeSite_stimSite_RT)
ggplot(emmRT4, aes(x = stim_site, y = emmean, group = timepoint, color = timepoint)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = lower.CL, ymax = upper.CL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Site') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Time Point by Stimulation Site
  labs(subtitle = 'Stimulation Time Point', color = 'Stimulation Time Point') +
  scale_x_discrete(label = stim_siteLabs) +
  scale_colour_manual(values = cbPalette, labels = timepoint_Labs) +
  facet_grid(. ~ timepoint, labeller = labeller(timepoint = timepoint_Labs))


#contrasts of contrasts for pre - post TMS across n_back loads
TimeSiteContrasts <- emmeans(TimeSite_m1, pairwise ~ timepoint * stim_site, param = 'logk') 
contrast(TimeSiteContrasts[[1]], interaction = c(stim_site = 'pairwise'))
```


### Three-way analysis of Pre/Post TMS, Stimulation Site (DAN, Vertex, FPCN-B) and n back load (0,1,2) interaction
```{r Three-way interaction reaction time}
#getting data frame for graphs. Grouping by subject, n_back load, pre/post TMS, and stimulation site. Then calculating mean and standard deviation accuracy
nBack_summaryTimeCogSess <- nBack_exp_filter_RT %>% group_by(subject, n_back, timepoint, stim_site) %>% summarize(medianRT = median(logrt), stdRT = sd(logrt))

#plot of above data frame
ggplot(nBack_summaryTimeCogSess, aes(timepoint, medianRT, fill = timepoint)) +
  geom_violin(width = 1) +
  geom_boxplot(width = .1, alpha = .2) +
  theme_classic() +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Log Transformed Reaction Time') +
  # title of figure: Log Transformed Reaction Time for Pre/Post-TMS\n by N-Back Load and Stimulation Site
  labs(subtitle = 'N-Back Load', fill = 'Stimulation Time Point') +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  facet_grid(stim_site ~ n_back, labeller = labeller(stim_site = stim_siteLabs)) +
  scale_fill_manual(values = cbPalette, labels = timepoint_Labs) +
  scale_x_discrete(labels = timepoint_Labs) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'Stimulation Site', breaks = NULL, labels = NULL))

#model with three-way interaction term. NOTE: ran into convergence issues when model was first run, elected to change optimizer to see if model converged. Below is the approach used
TimeCogSess_m1 <- lmer(logrt ~ n_back * timepoint * stim_site + days + (1 + days|subject:timepoint), data = nBack_exp_filter_RT, control=lmerControl(optimizer='bobyqa',optCtrl=list(maxfun=100000)))
#model without three-way interaction term
TimeCogSess_m2 <- lmer(logrt ~ n_back + timepoint + stim_site + days + n_back:timepoint + n_back:stim_site + timepoint:stim_site + (1 + days|subject:timepoint),  data = nBack_exp_filter_RT, control=lmerControl(optimizer='bobyqa',optCtrl=list(maxfun=100000)))
#anova comparing two models above
anova(TimeCogSess_m1, TimeCogSess_m2)
#summary of three-way interaction term model
summary(TimeCogSess_m1)
#vif of three-way interaction term model
vif(TimeCogSess_m1)
#tablated model
tab_model(TimeCogSess_m1)


#paired contrasts for differences between stimulation site for each n_back load and pre/post TMS (only pre is relevant here, really a sanity check to see if baseline levels differ as a function of n_back load but not across stimulation site)
emmTimeCogSess_TimeCog_RT <- emmeans(TimeCogSess_m1, ~ stim_site| timepoint * n_back, param = 'logk')
pairs(emmTimeCogSess_TimeCog_RT)
#graph of paired contrasts for model fitted data
RT3Way_TimeCog <- as.data.frame(emmTimeCogSess_TimeCog_RT)
ggplot(RT3Way_TimeCog, aes(x = stim_site, y = emmean, group = timepoint, color = n_back)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = lower.CL, ymax = upper.CL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Site') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Site by \nStimulation Time Point and N-Back Load 
  labs(subtitle = 'Stimulation Time Point', color = 'N-Back Load') +
  scale_x_discrete(labels = stim_siteLabs) +
  scale_colour_manual(values=cbPalette) +
  facet_grid(n_back ~ timepoint, labeller = labeller(timepoint = timepoint_Labs)) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'N-Back Load', breaks = NULL, labels = NULL))

ggplot(RT3Way_TimeCog, aes(x = stim_site, y = emmean, color = stim_site)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = lower.CL, ymax = upper.CL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Site') +
  ylab(label = 'Estimated Marginal Mean') +
  # title of figure: Estimated Marginal Means of Stimulation Site by \nStimulation Time Point and N-Back Load 
  labs(subtitle = 'Stimulation Time Point', color = 'Stimulation Site') +
  scale_x_discrete(labels = stim_siteLabs) +
  scale_colour_manual(values = cbPalette, labels = stim_siteLabs) +
  facet_grid(n_back ~ timepoint, labeller = labeller(timepoint = timepoint_Labs)) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'N-Back Load', breaks = NULL, labels = NULL))

ggplot(RT3Way_TimeCog, aes(x = stim_site, y = emmean, group = n_back, color = stim_site)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = lower.CL, ymax = upper.CL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Site') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Site by \nStimulation Time Point and N-Back Load 
  labs(subtitle = 'Stimulation Time Point', color = 'Stimulation Site') +
  scale_x_discrete(labels = stim_siteLabs) +
  scale_colour_manual(values = cbPalette, labels = stim_siteLabs) +
  facet_grid(n_back ~ timepoint, labeller = labeller(timepoint = timepoint_Labs)) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'N-Back Load', breaks = NULL, labels = NULL))

#paired contrasts for pre - post TMS for each n_back load and stimulation site
emmTimeCogSess_SiteCog_RT <-emmeans(TimeCogSess_m1, ~ timepoint | stim_site * n_back, param = 'logk')
pairs(emmTimeCogSess_SiteCog_RT)
#graph of paired contrasts for model fitted data
RT3Way_SiteCog <- as.data.frame(emmTimeCogSess_SiteCog_RT)
ggplot(RT3Way_SiteCog, aes(x = timepoint, y = emmean, group = stim_site, color = n_back)) +
  geom_point() +
  geom_line() +
  geom_errorbar(width = .1, aes(ymin = lower.CL, ymax = upper.CL)) +
  theme_bw() +
  theme(text = element_text(size = 22), plot.title = element_text(hjust = .5, margin = margin(b = 15)), plot.subtitle = element_text(hjust = .5), strip.background = element_blank(), axis.title.x = element_text(margin = margin(t = 10)), axis.title.y = element_text(margin = margin(r = 20))) +
  xlab(label = 'Stimulation Time Point') +
  ylab(label = 'Estimated Marginal Means') +
  # title of figure: Estimated Marginal Means of Stimulation Site by \nStimulation Time Point and N-Back Load 
  labs(subtitle = 'Stimulation Site', color = 'N-Back Load') +
  scale_x_discrete(labels = timepoint_Labs) +
  scale_colour_manual(values = cbPalette) +
  facet_grid(n_back ~ stim_site, labeller = labeller(stim_site = stim_siteLabs)) +
  scale_y_continuous(sec.axis = sec_axis(~ . , name = 'N-Back Load', breaks = NULL, labels = NULL))

#contrasts of contrasts for pre - post TMS across n_back load for each stimulation site
TimeCogSessContrastsTwoWayStim <- emmeans(TimeCogSess_m1, pairwise ~ timepoint * n_back | stim_site, param = 'logk')
contrast(TimeCogSessContrastsTwoWayStim[[1]], interaction = c(n_back = 'pairwise'))

#contrasts of contrasts for pre - post TMS across stimulation sites trial types for each n_back load
TimeCogSessContrastsTwoWayNback <- emmeans(TimeCogSess_m1, pairwise ~ timepoint* stim_site | n_back, param = 'logk')
contrast(TimeCogSessContrastsTwoWayNback[[1]], interaction = c(n_back = 'pairwise'))

#contrasts of contrasts of contrasts for pre-post TMS for n_back load for stimulation site
TimeCogSessContrastsThreeWay <- emmeans(TimeCogSess_m1, pairwise ~ timepoint* stim_site * n_back, param = 'logk')
contrast(TimeCogSessContrastsThreeWay[[1]], interaction = c(n_back = 'pairwise'))
```